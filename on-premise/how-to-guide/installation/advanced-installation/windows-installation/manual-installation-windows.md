# Ручная установка — Windows

На этой странице описан процесс **ручной установки** платформы **ГдеМои – Локальная версия** на Windows.  
Рекомендуем использовать **Windows Server 2016 и новее**. Если вы устанавливаете платформу на другую редакцию Windows (например, настольную), вы также можете следовать этому руководству: базовые принципы и ПО совпадают. Однако надёжным вариантом считаются именно серверные редакции.

Хотя платформа использует на Linux и Windows схожие сторонние компоненты, есть важные особенности работы сервисов в Windows:

* Java-сервисы запускаются как службы Windows с помощью YAJSW.  
* Nginx запускается как обычное фоновое приложение, а не как служба.

Для установки требуется учётная запись Windows с **правами администратора** (локальная или доменная — неважно; платформа не зависит от доменной инфраструктуры).

## Установка необходимых компонентов

Установите ПО из раздела [Программное обеспечение сервера](../../../requirements/server-software.md). Вкратце понадобится:

* [MySQL 8.0](https://dev.mysql.com/downloads/installer/) — достаточно компонента **Server**;  
  * Мастер установки может попросить Microsoft Visual C++ — установите при необходимости.
* [Java SE Development Kit 21](https://www.oracle.com/java/technologies/downloads/#jdk21-windows)
* [Nginx](https://nginx.org/en/download.html) — свежая версия (инсталлятор не требуется, достаточно распаковать архив)

Дополнительно рекомендуем:

* Архиватор с поддержкой `tar.gz`, например [7-Zip](https://www.7-zip.org/).  
* Расширенный текстовый редактор (конфигурации, большие логи), например [Notepad++](https://notepad-plus-plus.org/downloads/).

### Настройка MySQL

После установки MySQL примените настройки для корректной работы платформы. Конфигурационный файл:

`C:\ProgramData\MySQL\MySQL Server 8.0\my.ini`

В секции `[mysqld]` задайте/обновите параметры:

```
default-time-zone='+00:00'
sql-mode="NO_ENGINE_SUBSTITUTION"
innodb_buffer_pool_size=10G
```
`innodb_buffer_pool_size` — объём ОЗУ под MySQL. Рекомендуем выставить ~**70% общей RAM** сервера (в гигабайтах).

Сохраните файл и **перезапустите MySQL** (services.msc), чтобы применить изменения.

### Переменные окружения

Добавьте пути к `bin` Java и MySQL в системную переменную `PATH`, а путь к Java — в переменную `JAVA_HOME`:

* `C:\Program Files\Java\jdk-21\bin`
* `C:\Program Files\MySQL\MySQL Server 8.0\bin`
* `JAVA_HOME = C:\Program Files\Java\jdk-21`

Имена папок могут отличаться — проверьте фактические пути.

Обновить переменные можно из командной строки (от имени администратора):

```
setx /m Path "%PATH%;C:\Program Files\Java\jdk-21\bin;C:\Program Files\MySQL\MySQL Server 8.0\bin"
setx /m JAVA_HOME "C:\Program Files\Java\jdk-21"
```
Проверьте версии:

```
mysql -V
java -version
```
Если видите ошибки вида `is not recognised as an internal or external command`, проверьте заданные пути.

## Распаковка платформы

Дистрибутив **ГдеМои – Локальная версия** распространяется в архиве `.tar.gz`. Актуальная версия доступна по ссылке:

[⬇️ Скачать пакет ГдеМои – Локальная версия](https://get.navixy.com/latest)

Сохраните и распакуйте архив. Учтите, что в пакете много вложенных папок — не превышайте ограничение Windows на длину пути (≈255 символов).

Поместите папку `navixy-package` в удобный каталог, например: `C:\distrib\navixy-package`

Далее в инструкции пути вида `...navixy-package\...` означают работу из этой папки и её подкаталогов.

## Базы данных ГдеМои

Сначала создайте пользователя и базы в MySQL. Подключитесь под `root`:

```
mysql -uroot -p
```
Выполните SQL-блок (вместо `<PASSWORD>` укажите пароль для пользователя `navixy` и **запомните его**):

```
CREATE USER navixy@'%' IDENTIFIED BY '<PASSWORD>' WITH MAX_QUERIES_PER_HOUR 0 MAX_UPDATES_PER_HOUR 0 MAX_CONNECTIONS_PER_HOUR 0 MAX_USER_CONNECTIONS 0;
CREATE DATABASE google CHARACTER SET utf8 COLLATE utf8_general_ci;
CREATE DATABASE tracking CHARACTER SET utf8 COLLATE utf8_general_ci;
GRANT USAGE ON *.* to navixy@'%';
GRANT ALL PRIVILEGES ON google.* TO navixy@'%';
GRANT ALL PRIVILEGES ON tracking.* TO navixy@'%';
```
Будут созданы пустые базы данных.

Выйдите из MySQL.

### Импорт структуры данных

Перейдите в каталог `...navixy-package\db` и выполните импорт структуры таблиц бизнес-данных.  
Для этого в командной строке введите:

```
bash
mysql -uroot -p google < google.sql
```

Дождитесь завершения процесса — структура таблиц будет создана.
После этого удалите файлы updates.sql и google.sql, так как они не потребуются на следующем этапе:

```
del updates.sql
del google.sql
```

Теперь необходимо импортировать остальные SQL-файлы, чтобы добавить данные по умолчанию.
Выполните следующую команду:

```
type *.sql | mysql -uroot -p google
```
После выполнения этой команды база данных будет полностью инициализирована.

### Настройка файлового хранилища

Подключитесь к MySQL повторно, затем выполните указанный ниже SQL-запрос. Он создаст локальное файловое хранилище, которое используется для загрузки файлов и изображений с мобильных приложений и веб-интерфейса — например, в формах обслуживания, заявках, отчётах и т. д.
Измените `api.domain.com` на ваш домен API и при необходимости замените `https` на `http`, если SSL не используется.
```
INSERT INTO google.file_storages (id, engine, config) values (1, 'local_fs', '{"base_path":"./files/","base_upload_url":"https://api.domain.com/file/upload","base_download_url":"https://api.domain.com/file/dl","secret":"s3cCr3Et","upload_credentials_ttl":"10m","is_dynamic_preview_enabled": true,"dynamic_preview_pattern":"(.+)/file/dl/(.+)","dynamic_preview_replace":"$1/file/preview/$2","security_module":{"type":"hashid","salt":"S4lTh45hV4lu3","ttl":"7d","min_length":8}}');
```

Значения параметров `secret` и `salt` рекомендуется заменить на случайные наборы букв и цифр. Это повысит безопасность хранилища.

### Лицензионный ключ

После инициализации базы данных необходимо применить лицензионный ключ (fingerprint), выданный отделом технических решений. Он представляет собой длинную строку из букв и цифр.
Выполните запрос, подставив свой ключ вместо `<FINGERPRINT>`:

```
UPDATE google.variables SET value='<FINGERPRINT>' WHERE var='fingerprint';
```

Fingerprint является динамическим ключом. Он обновляется каждый раз, когда сервер обращается к лицензирующему серверу `auth.gdemoi.ru` — это происходит каждые 3 дня и при каждом перезапуске сервисов. Поэтому нет необходимости сохранять ключ отдельно: он регулярно обновляется. Также его нельзя использовать на нескольких серверах — лицензия действует только для одной платформы.

## Фронтенд

Следующим шагом необходимо настроить фронтенд платформы **ГдеМои — Локальная версия** — веб-сервер **Nginx** и статические файлы пользовательского интерфейса.

Создайте папку `nginx` на диске `C:`.

```
md nginx
```
Скопируйте распакованный дистрибутив Nginx в `C:\nginx`.

![Папка Nginx](../../../../../on-premise-how-to-guide/installation/advanced-installation/windows-installation/attachments/image-20230928-145508.png)

### Статические файлы

Создайте папку `www` в `C:\nginx`. Скопируйте в неё каталоги `panel-v2` и `pro-ui` из `navixy-package`. Эти папки содержат статические файлы веб-интерфейса платформы — фактически, весь её видимый контент.

Теперь переименуйте конфигурационные файлы:

* В папке `\panel-v2` переименуйте `PConfig.example.sa.js` → `PConfig.js`
* В папке `\pro-ui` переименуйте `Config.example.sa.js` → `Config.js`
* В папке `\pro-ui\static` переименуйте `app_config.example.sa.js` → `app_config.js`

Во всех этих шагах просто удалите часть `.example.sa` из имени файла. Будьте внимательны — в каталогах могут быть похожие файлы.

### Настройка Nginx

Откройте файл `C:\nginx\conf\nginx.conf` и в блоке `http` добавьте строки:

```
include conf.d/*.conf;
server_names_hash_bucket_size 64;
```

Скопируйте папку `include` из `...navixy-package\windows\nginx` в `C:\nginx\conf`.

Создайте папку `conf.d` в `C:\nginx\conf`. Эта папка будет содержать конфигурационные файлы сайта платформы.

Из `...navixy-package\windows\nginx` скопируйте в неё следующие файлы:

* `map.conf`
* `navixy.conf`

Если планируется использование SSL (HTTPS), скопируйте также файл:

* `navixy_ssl.conf`

Далее настройте файлы `navixy.conf` и (если используется SSL) `navixy_ssl.conf` в соответствии с инструкцией  
[Конфигурация Nginx](../../../configuration/nginx-web-server.md). Эти файлы определяют работу веб-сервера, поэтому редактируйте их внимательно.

### Настройка HTTPS

Для корректной работы HTTPS потребуется действующий SSL-сертификат, выданный на ваш домен, и соответствующий ему приватный ключ.  
Если сертификат или ключ отсутствуют, Nginx с параметром `443 ssl` не запустится.

Подробнее об установке и использовании SSL-сертификатов см. в разделе  
[Установка SSL-сертификатов](../../../configuration/ssl-certificates/ssl-certificates-installation.md).

### Запуск Nginx

После выполнения всех шагов запустите `nginx.exe` **от имени администратора**.  
Убедитесь, что сервер работает — в диспетчере задач обычно отображаются два и более процесса Nginx.

Если сервер останавливается или не запускается, проверьте журнал ошибок:

```
C:\nginx\logs\error.log
```
и внесите необходимые исправления в конфигурацию.

![Работающий Nginx](../../../../../on-premise-how-to-guide/installation/advanced-installation/windows-installation/attachments/image-20231011-123558.png)


## Бэкенд

Этот этап состоит из двух шагов: настройка Java-сервисов и их преобразование в службы Windows.

### Предварительная настройка Java-сервисов

Создайте папку `java` на диске `C:`.

```
md java
```

Скопируйте из `...navixy-package` в `C:\java` следующие каталоги:

* `api-server`
* `sms-server`
* `tcp-server`

В каждой из этих папок переместите подкаталог `conf` из директории `dist` в корень сервиса. Для удобства можно воспользоваться следующими командами:

```
move C:\java\api-server\dist\conf C:\java\api-server\
move C:\java\sms-server\dist\conf C:\java\sms-server\
move C:\java\tcp-server\dist\conf C:\java\tcp-server\
```

Откройте поочерёдно каждую из трёх папок `conf` и найдите файл `db.properties`. Это конфигурационные файлы, с помощью которых сервисы подключаются к базе данных. Для корректной работы всех сервисов необходимо указать правильные данные для подключения. Измените строки:

```
db.username=navixy
db.password=<PASSWORD>
```

Здесь `<PASSWORD>` — это пароль пользователя базы данных `navixy`, который вы задали ранее.

Если база данных размещена на отдельном сервере, измените строку `db.connectionString`, указав фактический IP-адрес или домен сервера базы данных вместо `localhost`, но не меняйте другие параметры строки.

### Java-сервис **api-server**

Откройте файл `C:\java\api-server\conf\config.properties` и отредактируйте следующие строки:

* `api.externalBaseUrl=` — адрес вашего домена API (начинается с `http://` или `https://`);
* `feedback.toEmail=test@localhost` — адрес, на который будут поступать сообщения из раздела обратной связи;
* `feedback.defaultFromEmail=do-not-reply@localhost` — адрес отправителя таких сообщений по умолчанию;
* `feedback.substituteFromEmail=false` — если указано `true`, письма будут отправляться с адреса пользователя, иначе — с адреса по умолчанию.

Если у вас нет отдельного домена для API, укажите здесь основной домен с добавлением `/api`, например:
`https://my.domain.com/api`.

### Java-сервис **sms-server**

Этот сервис не требует дополнительной настройки и использует конфигурацию по умолчанию.

### Java-сервис **tcp-server**

Откройте файл `C:\java\tcp-server\conf\config.properties` и измените строки:

* `externalIP=127.0.0.1` - укажите вместо `127.0.0.1` реальный IP-адрес вашего пользовательского интерфейса.
* `externalHostname=myhost.ru` - укажите вместо `myhost.ru` домен пользовательского интерфейса.

Эти данные используются для автоматической активации устройств.

### Преобразование Java-сервисов в службы Windows

На этом этапе используется стороннее программное обеспечение **YAJSW (Yet Another Java Service Wrapper)**. Оно позволяет запускать Java-приложения как службы Windows.  
Подробнее о проекте можно узнать на [официальном сайте YAJSW](https://yajsw.sourceforge.io/).  
Необходимые файлы уже включены в дистрибутив платформы.

Скопируйте папку `wrapper` из `...navixy-package\windows` в `C:\java`.

Запустите командную строку **от имени администратора** и перейдите в каталог:

```
cd C:\java\wrapper\bat
```

Выполните команду для настройки окружения:

```
setenv.bat
```

Затем поочерёдно выполните команды:

```
wrapper.bat -i ../conf/wrapper.api-server.conf
wrapper.bat -i ../conf/wrapper.sms-server.conf
wrapper.bat -i ../conf/wrapper.tcp-server.conf
```

Эти команды установят Java-сервисы платформы как стандартные службы Windows.

### Проверка служб

Откройте оснастку **Services** (через меню «Пуск» или командой `services.msc`).

Найдите в списке установленные службы:

* **Navixy api-server**
* **Navixy sms-server**
* **Navixy tcp-server**

Запустите их вручную по очереди.

![Службы Windows](../../../../../on-premise-how-to-guide/installation/advanced-installation/windows-installation/attachments/image-20231010-113440.png)

Убедитесь, что все службы находятся в состоянии **Running (Работает)** и продолжают функционировать.  
Если какая-либо из них завершает работу, проверьте журнал ошибок согласно инструкции:  
[Работа с логами](../../../troubleshooting/working-with-logs/).

## Завершающие действия

### Доступ к панели администратора

После завершения установки и запуска всех сервисов проверьте доступность домена вашей панели администратора в браузере.  
При переходе по адресу вы должны увидеть страницу входа в систему.  
Если домен не открывает нужную страницу, перепроверьте настройки веб-сервера — вероятнее всего, ошибка в конфигурации Nginx.

После успешного входа обязательно смените пароль для панели администратора, поскольку по умолчанию используются стандартные учётные данные:

* Имя пользователя: _admin_
* Пароль: _admin_

### Доступ к пользовательскому интерфейсу

Чтобы пользовательский интерфейс платформы был доступен, необходимо указать его домен в панели администратора, в разделе **Service Preferences**.  
Подробнее см. в инструкции: [Доменное имя](https://app.gitbook.com/s/KdgeXg71LpaDrwexQYwp/settings/domain-name).

Если домен не задан, пользовательский интерфейс не будет открываться.

### Обновление платформы

Чтобы обновить платформу **ГдеМои — Локальная версия**, установленную на Windows, до актуальной версии, воспользуйтесь руководством:  
[Обновление на Windows](../../update/update-windows/)

### Диагностика и устранение неполадок

Если в процессе установки или настройки возникли ошибки, обратитесь к разделу  
[Диагностика и устранение неполадок](../../../troubleshooting/), где собраны возможные решения типовых проблем.
