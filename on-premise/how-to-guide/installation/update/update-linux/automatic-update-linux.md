# Автоматическое обновление — Linux

Процесс обновления платформы **ГдеМои — Локальная версия** обычно состоит из трёх этапов:  
обновление базы данных, обновление файлов Java-сервисов и обновление файлов веб-интерфейса.  
Важно строго соблюдать порядок действий и убедиться, что каждый шаг выполнен успешно, без ошибок.

Если во время обновления возникли ошибки или другие сложности, сразу обратитесь в **отдел технических решений**:  
[solutions@gdemoi.ru](mailto:solutions@gdemoi.ru)  
Незавершённое обновление может привести к некорректной работе платформы или сделать её недоступной.

---

## Проверка требований

Перед началом убедитесь, что ваша система соответствует следующим условиям:

1. **Java Development Kit 21**  
   С марта 2025 года поддержка версий 17 и ниже прекращена.
2. **MySQL 8.0**  
   С марта 2024 года поддержка MySQL 5.7 прекращена, так как эта версия достигла конца жизненного цикла (EOL).

Несоблюдение этих требований приведёт к невозможности запуска новой версии платформы.  
Рекомендуется предварительно обновить необходимые компоненты, чтобы система оставалась работоспособной.

---

## Начало обновления

Распакуйте архив дистрибутива, полученный от отдела технических решений.  
Файл обычно имеет расширение `.tar.gz`:

```
tar -zxvf $PACKAGENAME

(где `$PACKAGENAME` — имя файла архива)

После распаковки будет создан каталог `/navixy-package`, содержащий все файлы платформы.  
Дальнейшие действия выполняются из этого каталога.

---

## Автоматическое обновление

Для платформ, размещённых на серверах под управлением **Linux**, предусмотрен автоматический сценарий обновления.  
Рекомендуется использовать скрипт `update.sh`, который выполняет поэтапное обновление базы данных и файлов системы без ручного вмешательства.

Запустите скрипт из каталога `/navixy-package`.  
Если ваша установка разделена на два сервера, выполняйте обновление на **сервере приложений** (где работают Java-сервисы).

```
root@server:/home/navixy-package# ./update.sh
```

Сначала будет выполнено обновление базы данных.  
Если база находится на отдельном сервере, скрипт возьмёт данные подключения из конфигурации Java-сервисов.

После обновления базы данных (этот процесс может занять некоторое время) скрипт продолжит обновление системных файлов платформы.

Если во время обновления появится сообщение:

```
It seems Navixy services is not under systemd control. Do you want to create systemd services (runit services will be removed)? (y/n)
```

рекомендуется ответить **y (Yes)**.  
Платформа больше не использует систему **runit**, вместо этого сервисы инициализируются **systemd**.  
Скрипт выполнит все необходимые изменения автоматически.  
Если вы выберете **n (No)**, система продолжит работать, но переход на systemd можно будет выполнить при следующем обновлении.

---

### Отдельное обновление базы данных (опционально)

При необходимости вы можете обновить базу данных отдельно от других компонентов.  
Для этого запустите скрипт `update-db.sh` из каталога `/navixy-package`.  
Скрипт можно выполнять как на сервере базы данных, так и с другого сервера, указав адрес хоста.  
После запуска появится диалог:

```
Enter mysql host [localhost]:
Enter mysql port [3306]:
Enter mysql user name [root]:
Updating Navixy db..
Enter password:
```

Значения в квадратных скобках — параметры по умолчанию.  
Если они совпадают с фактическими, просто нажмите **Enter**.  
В противном случае введите нужные данные.

Если после обновления что-то работает некорректно, перезапустите сервисы командой:

```
restart-navixy
```

Также очистите кэш браузера или проверьте работу в режиме инкогнито.

---

## Ручное обновление

Автоматическое обновление — надёжный и рекомендуемый способ.  
Ручные действия описаны ниже и предназначены для нетипичных или кастомных установок.

### Обновление базы данных

Перейдите в каталог `navixy-package/db` и выполните команду:

```
mysql -uroot -p$ROOTPASSWORD google < updates.sql
```

(где `$ROOTPASSWORD` — пароль пользователя root MySQL)

После выполнения удалите файлы `updates.sql` и `google.sql`, чтобы избежать их повторного применения:

```
rm updates.sql
rm google.sql
```

Убедитесь, что файлы действительно удалены, затем выполните оставшиеся SQL-скрипты:

```
cat *.sql | mysql -uroot -p$ROOTPASSWORD google
```

---

### Обновление Java-сервисов

Для обновления Java-сервисов замените файлы в каталогах `/home/java`:

* `api-server`
* `sms-server`
* `tcp-server`

Замените все файлы, **кроме** `config.properties` и `db.properties` в папках `conf`.  
Сравните ваши текущие `config.properties` с новыми — если появились дополнительные параметры, добавьте их вручную.

---

### Обновление веб-интерфейса

Перейдите в каталог `/var/www` и замените содержимое папок:

* `panel-v2`
* `pro-ui`

на соответствующие файлы из нового дистрибутива.  
Это не затронет настройки, так как конфигурационные файлы в архиве имеют суффикс `_example_` и не перезаписывают существующие.

Проверьте и при необходимости обновите параметры в файлах:

* `panel-v2/Config.js`
* `pro-ui/PConfig.js`
* `pro-ui/static/app_config.js`

---

## Завершение обновления

После завершения обновления перезапустите Java-сервисы:

```
restart-navixy
```

Убедитесь, что все сервисы успешно запущены и работают не менее одной минуты.  
Это будет означать, что обновление платформы завершено корректно.
