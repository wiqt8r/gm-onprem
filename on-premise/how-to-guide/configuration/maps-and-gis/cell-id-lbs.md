# Cell ID / LBS

Данная страница описывает процесс настройки службы определения местоположения по сотам (Cell ID / LBS) в платформе **ГдеМои — Локальная версия**.  
Чтобы узнать больше о назначении функции и её возможностях в пользовательском интерфейсе, обратитесь к соответствующему разделу руководства пользователя.

---

## Настройка функции Cell ID / LBS

Все операции LBS выполняются на уровне TCP-сервера, поэтому активация и настройка функции выполняются в его конфигурационном файле:

* для Linux: `/home/java/tcp-server/conf/config.properties`

---

### Включение функции Cell ID / LBS

Чтобы активировать поддержку LBS, в конфигурационном файле должно присутствовать следующее значение:

```
geocodingService.lbs.enabled=true
```

В зависимости от версии платформы этот параметр может отсутствовать или иметь значение `false`.  
Если его нет, добавьте строку вручную в конце файла.

---

### Интервал обновления

По умолчанию платформа **ГдеМои** отправляет запросы к службе LBS каждые **20 минут**, если GPS-координаты не обновлялись.  
Интервал можно изменить, добавив параметр (время задаётся в минутах):

```
geocodingService.lbs.delay=15m
```

После изменения конфигурации необходимо **перезапустить tcp-server**, чтобы новые параметры вступили в силу.

---

## Базы данных LBS

Платформа поддерживает два варианта LBS-сервисов:

* **Mozilla Location Services (MLS)**
* **Google LBS**

Выбор осуществляется параметром `lbs.service_url` в файле `/home/java/tcp-server/conf/config.properties`.

**Вариант 1. Mozilla Location Services (MLS)**

```
lbs.service_url=http://location.services.mozilla.com/v1/geolocate?key=test
```

**Вариант 2. Google LBS**

```
lbs.service_url=https://www.googleapis.com/geolocation/v1/geolocate?key=YOUR_API_KEY
```

---

### Mozilla Location Services (по умолчанию)

По умолчанию используется служба **Mozilla Location Services (MLS)** — это открытый общедоступный геолокационный сервис,  
который обрабатывает LBS-запросы и возвращает координаты на основе данных сети.

Производительность MLS обычно достаточна, однако точность и стабильность не гарантируются.  
Иногда сервис может не возвращать координаты из-за перегрузки или отсутствия данных в своей базе.

Если такая ситуация возникает часто, а LBS является критически важной функцией,  
можно перейти на использование **Google LBS**, предоставляющего гарантированное качество работы.

---

### Google LBS

Чтобы использовать Google LBS, выполните следующие шаги:

1. Получите API-ключ Google для службы геолокации (платная услуга).  
2. Добавьте ключ в конфигурацию API-сервера `/home/java/api-server/conf/config.properties`:
```
lbs.google.apiKey=KEY
```
(где `KEY` — ваш персональный ключ).
3. В панели администратора откройте **Управление аккаунтом → Настройки сервиса**  
и в параметре **Определение по Cell ID** выберите **Google**.

![On-Premise - Maps and GIS - Cell ID - LBS](../../../../on-premise/on-premise/configuration/maps-and-gis/attachments/image-20230810-133150.png)

4. Убедитесь, что в тарифных планах для устройств включена опция **Определение по Cell ID**.

![On-Premise - Maps and GIS - Cell ID - LBS](../../../../on-premise/on-premise/configuration/maps-and-gis/attachments/image-20230810-133203.png)

---

⚠️ **Важно:**  
Google взимает плату за каждый запрос LBS.  
При большом количестве устройств расходы могут быть значительными.  
Чтобы сократить издержки, рекомендуется включать опцию **Определение по Cell ID** только для отдельных тарифных планов.  
Запросы к LBS будут выполняться только для устройств, использующих такие планы.  
Если опция отключена, данные LBS не обрабатываются, даже если устройство их отправляет.
